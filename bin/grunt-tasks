#!/usr/bin/env node

var path = require("path"),
	prompt = require("prompt"),
	fs = require("fs-extra"),
	_ = require("lodash"),
	targetDir = "./grunt/tasks",
	fromPath = path.join(__dirname, '..', 'grunt', 'tasks');

require("colors");

prompt.message = "";
prompt.delimiter = "";

function identical(file1, file2) {
	file1 = fs.readFileSync(file1).toString().replace(/\s+/g, ' ');
	file2 = fs.readFileSync(file2).toString().replace(/\s+/g, ' ');
	return file1 === file2;
}

if (fs.existsSync(targetDir)) {
	var exists;
	_.each(fs.readdirSync(fromPath), function(file) {
		var targetFile = path.join(targetDir, file);
		if (fs.existsSync(targetFile) && !identical(targetFile, path.join(fromPath, file))) {
			exists = exists || {};
			exists[file] = {
				description: file + " exists, overwrite? (Y)".green
			};
		} else {
			fs.copySync(path.join(fromPath, file), targetFile);
		}
	});
	if (exists) {
		prompt.get({
				properties: exists
			},
			function(err, result) {
				if (err) {
					console.error("Error:" + err + "".red);
				} else if (result) {
					_.each(result, function(overwrite, file) {
						if (overwrite === "Y") {
							console.warn(("Overwrite: " + file).yellow);
							fs.copySync(path.join(fromPath, file), path.join(targetDir, file));
						}
					});
				}
			});
	}
} else {
	fs.copySync(fromPath, targetDir);
	console.log("Done adding grunt tasks.\n".cyan);
}